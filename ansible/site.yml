---
- name: Fedora dotfiles bootstrap (local)
  hosts: local
  gather_facts: true
  become: true

  vars:
    repo_root: "{{ playbook_dir }}/.."
    hyprland_copr: "solopasha/hyprland"

    dnf_conf_block: |
      # Added/managed by Fedora-Dotfiles
      fastestmirror=True
      max_parallel_downloads=10
      defaultyes=True
      keepcache=True

    base_packages:
      - git
      - curl
      - wget
      - vim
      - htop
      - btop
      - fastfetch
      - bat
      - lsd
      - ranger
      - neovim
      - flatpak
      - zsh
      - zsh-autosuggestions
      - zsh-syntax-highlighting
      - fcitx5
      - fcitx5-configtool

    hyprland_packages:
      - hyprland
      - waybar
      - rofi
      - dunst
      - mako
      - grim
      - slurp
      - swappy
      - swaybg
      - swaylock
      - wf-recorder
      - pavucontrol
      - network-manager-applet
      - blueman
      - xdg-desktop-portal
      - xdg-desktop-portal-hyprland

    flatpaks:
      - org.wezfurlong.wezterm
      - md.obsidian.Obsidian
      - org.telegram.desktop
      - com.spotify.Client

  tasks:
    - name: Ensure dnf.conf contains performance defaults
      ansible.builtin.blockinfile:
        path: /etc/dnf/dnf.conf
        create: true
        marker: "# {mark} Fedora-Dotfiles"
        block: "{{ dnf_conf_block }}"

    - name: Enable RPM Fusion repositories
      ansible.builtin.dnf:
        name:
          - "https://mirrors.rpmfusion.org/free/fedora/rpmfusion-free-release-{{ ansible_facts.distribution_major_version }}.noarch.rpm"
          - "https://mirrors.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-{{ ansible_facts.distribution_major_version }}.noarch.rpm"
        state: present
        # First-time setup often fails with "OpenPGP keys not configured" before the
        # rpmfusion release RPM drops its key files into /etc/pki/rpm-gpg.
        # We verify packages from repos after importing keys below.
        disable_gpg_check: true

    - name: Import RPM Fusion GPG keys (free/nonfree)
      ansible.builtin.rpm_key:
        key: "{{ item }}"
        state: present
      loop:
        - "/etc/pki/rpm-gpg/RPM-GPG-KEY-rpmfusion-free-fedora-{{ ansible_facts.distribution_major_version }}"
        - "/etc/pki/rpm-gpg/RPM-GPG-KEY-rpmfusion-nonfree-fedora-{{ ansible_facts.distribution_major_version }}"
      failed_when: false

    - name: Update packages
      ansible.builtin.dnf:
        name: "*"
        state: latest

    - name: Ensure COPR tooling is installed
      ansible.builtin.dnf:
        name:
          - dnf-plugins-core
        state: present

    - name: Check whether Hyprland is available in enabled repos
      ansible.builtin.command: dnf -q info hyprland
      register: hyprland_info
      changed_when: false
      failed_when: false

    - name: Enable Hyprland COPR when Hyprland isn't available
      ansible.builtin.command: dnf -y copr enable {{ hyprland_copr }}
      when: hyprland_info.rc != 0
      changed_when: true

    - name: Refresh package metadata after enabling COPR
      ansible.builtin.dnf:
        update_cache: true
      when: hyprland_info.rc != 0

    - name: Preflight - check which requested packages exist
      ansible.builtin.command: dnf -q info {{ item }}
      register: pkg_availability
      changed_when: false
      failed_when: false
      loop: "{{ (base_packages + hyprland_packages) | unique }}"

    - name: Build installable and missing package lists
      ansible.builtin.set_fact:
        installable_packages: "{{ pkg_availability.results | selectattr('rc', 'eq', 0) | map(attribute='item') | list }}"
        missing_packages: "{{ pkg_availability.results | rejectattr('rc', 'eq', 0) | map(attribute='item') | list }}"

    - name: Show missing packages (if any)
      ansible.builtin.debug:
        msg:
          - "Some requested packages are not available in current repos and will be skipped:"
          - "{{ missing_packages }}"
      when: missing_packages | length > 0

    - name: Install all available packages
      ansible.builtin.dnf:
        name: "{{ installable_packages }}"
        state: present
        skip_broken: true

    - name: Ensure flathub remote exists
      become: false
      ansible.builtin.command: flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
      changed_when: false

    - name: Install flatpaks
      become: false
      ansible.builtin.command: flatpak install -y flathub {{ item }}
      loop: "{{ flatpaks }}"
      register: flatpak_install
      changed_when: "'Installing:' in (flatpak_install.stdout | default(''))"
      failed_when: false

    - name: Ensure user config directories exist
      become: false
      ansible.builtin.file:
        path: "{{ ansible_env.HOME }}/{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - .config
        - .android
        - .local/share/fonts

    - name: Copy dotfiles (.config)
      become: false
      ansible.builtin.copy:
        src: "{{ repo_root }}/.config/"
        dest: "{{ ansible_env.HOME }}/.config/"
        mode: preserve
        backup: true

    - name: Copy .zshrc
      become: false
      ansible.builtin.copy:
        src: "{{ repo_root }}/.zshrc"
        dest: "{{ ansible_env.HOME }}/.zshrc"
        mode: "0644"
        backup: true

    - name: Copy Android Studio settings stub (.android)
      become: false
      ansible.builtin.copy:
        src: "{{ repo_root }}/.android/"
        dest: "{{ ansible_env.HOME }}/.android/"
        mode: preserve
        backup: true

    - name: Install fonts into user font dir
      become: false
      ansible.builtin.copy:
        src: "{{ repo_root }}/fonts/"
        dest: "{{ ansible_env.HOME }}/.local/share/fonts/"
        mode: preserve

    - name: Rebuild font cache
      become: false
      ansible.builtin.command: fc-cache -f
      changed_when: false

    - name: Set default shell to zsh for current user (if available)
      ansible.builtin.user:
        name: "{{ ansible_user_id }}"
        shell: /usr/bin/zsh


